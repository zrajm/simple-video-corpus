<!DOCTYPE html><!--*-js-indent-level:2;css-indent-offset:2-*-->
<meta charset="utf-8">
<link rel=icon href="data:,">
<title>Simple Video Corpus</title>
<style>
  /* Mini reset. */
  html { box-sizing: border-box; }
  *, :before, :after { box-sizing: inherit; padding: 0; margin: 0; }

  /* Form. */
  form { margin: 1rem 0; line-height: 2rem; }
  input[type="range"] { vertical-align: middle; }
  #player > button { padding: .5rem 1rem; }

  /* Page layout. */
  div[id^="wrap-"] {
    width: 50vw;
    height: 100vh;
    position: fixed;
    max-height: 100vh;
    overflow: auto;
    padding: .75rem 1rem;
  }
  div#wrap-video { left: 0; }
  div#wrap-annot { right: 0; }

  /* Annotation field. */
  #annot {
    position: relative;
    background: #ccf;
    height: 100vh; /* height is set by javascript below */
  }
  /* An annotation in the annotation field. */
  #annot > div {
    position: absolute;
    border-radius: 4px;
    background: #88f;
    border: 2px solid #0008;
    padding: .125rem .25rem;
    cursor: pointer;
  }
  #annot > div:hover {
    z-index: 1;
    background: #aaf;        /* lighter background */
    border: 2px solid #0006; /* lighter border */
  }
</style>
<body>
  <div id=wrap-video>
    <video
      width=576 height=432 controls
      onplay="playAnnot()"
      onpause="stopAnnot()"
      ></video>
    <form>
      Video:
      <select name=video onchange="loadVideo(video.value)">
        <option value="x/sslc01_003.tsv">SSLC01 003</option>
        <option value="x/sslc01_222.tsv">SSLC01 222</option>
      </select>
      Â  Annotering:
      <select name=file onchange="loadAnnotations(file.value)"></select>
      <br>Scale:
      <input name=scale type=range min=10 max=250 value=50
        oninput="scaleOut.value = rescale(scale.value)">
      <output id=scaleOut for=scale></output>
    </form>
    <div id=player>
      <button onclick="seek()" title="Backwards to start">
        <svg width="24" height="24">
          <path fill="currentColor" d="M2.25 21h1.5V3h-1.5zm1.5-9 9 9V3Zm18 9-9-9 9-9Z"/>
        </svg>
      </button>
      <button onclick="seek(-5)" title="Backwards 5 seconds">
        <svg width="24" height="24">
          <path fill="currentColor" d="m3 12 9 9V3Zm18 9-9-9 9-9Z"/>
        </svg>
      </button>
      <button onclick="play()" title="Play/Pause">
        <svg width="24" height="24">
          <path fill="currentColor" d="m2 21 9-9-9-9zm13 0h-4V3h4Zm7 0h-4V3h4z"/>
        </svg>
      </button>
      <button onclick="seek(+5)" title="Forwards 5 seconds">
        <svg width="24" height="24">
          <path fill="currentColor" d="m21 12-9 9V3ZM3 21l9-9-9-9Z"/>
        </svg>
      </button>
    </div>
  </div>
  <div id=wrap-annot>
    <div id=annot></div>
  </div>
</body>
<script src="jquery-3.6.0.slim.min.js"></script>
<script>
  // Settings.
  let scaleFactor = 50
  const minAnnotHeight = 24
  const annotUpdateInterval = 13  // milliseconds
  const wheelIdleTime = 300       // milliseconds

  // Data.
  let annotations = []
  let annotPointer     // pointer down
  let annotWheel       // scroll wheel active
  let annotTimer
  const updatesPerSecond = 1000 / annotUpdateInterval
  const video = $('video')[0]  // plain DOM element
  const $annotWrap = $('#wrap-annot')
  const $annot = $('#annot')

  function parseTSV(data = '') {
    return data.trim().split('\n').map(l => l.split('\t'))
  }
  function scaleCoord(length, scaleFactor, minHeight = 0) {
    return Math.max(scaleFactor * length, minHeight)
  }
  function loadVideo(videoUrl) {
    const videoDir = videoUrl.replace(/\/[^\\]*$/, '')
    window.fetch(videoUrl)
      .then(response => response.text())
      .then(tsv => {                      // tab-separated values
        const [videos, ...tiers] = parseTSV(tsv)
        $('video').attr({ src: `${videoDir}/${videos[0]}` })
        const html = tiers.map(([name, file, count]) => {
          return `<option value="${videoDir}/${file}">${name} (${count})\n`
        }).join('')
        $('[name="file"]').html(html).trigger('change')
      })
      .catch(error => {
        // FIXME: Handle error in file loading here.
      })
  }
  function loadAnnotations(annotUrl) {
    window.fetch(annotUrl)
      .then(response => response.text())
      .then(data => {
        annotations = parseTSV(data)
        redrawAnnotations()
      })
      .catch(error => {
        // FIXME: Handle error in file loading here.
      })
  }
  function redrawAnnotations() {
    if (annotations.length === 0) { return [] }
    const lastAnnot = annotations[annotations.length - 1]
    const annotHeight =  // video length = last annotation start + length
      scaleCoord(lastAnnot[0], scaleFactor) +
      scaleCoord(lastAnnot[1], scaleFactor, minAnnotHeight)
    $annot.css({ height: `${annotHeight}px` })

    // Clear annotation field and fill with new annotations.
    $annot.empty()
    for (const annot of annotations) {
      const [ start, length, value ] = annot
      const top    = scaleCoord(start,  scaleFactor)
      const height = scaleCoord(length, scaleFactor, minAnnotHeight)
      $annot.append(`<div style="top:${top}px;height:${height}px">${value}`)
    }
  }
  function rescale(newScale) {
    const newScrollTop = ($annotWrap.scrollTop() / scaleFactor) * newScale
    scaleFactor = newScale
    redrawAnnotations()
    $annotWrap.scrollTop(newScrollTop)
    return scaleFactor
  }
  function play() {
    video[video.paused ? 'play' : 'pause']()
  }
  function seek(secs) {
    const playing = !!annotTimer
    if (playing) { play() }
    $annotWrap[0].scrollTop = secs
      ? $annotWrap[0].scrollTop + (secs * scaleFactor)
      : 0
    if (playing) { play() }
  }
  function stopAnnot() {
    annotTimer = clearTimeout(annotTimer)
  }
  function playAnnot() {
    let prevPos = $annotWrap[0].scrollTop
    let floatPos = prevPos
    annotTimer = setInterval(() => {
      if (annotPointer || annotWheel) {
        prevPos = floatPos = $annotWrap[0].scrollTop
      } else {
        floatPos = floatPos + (scaleFactor / updatesPerSecond)
        prevPos = $annotWrap[0].scrollTop = Math.round(floatPos)
      }
    }, annotUpdateInterval)
  }
  $(() => {
    $('select').trigger('change')         // load annotations
    $('[type="range"]').trigger('input')  // update scale value

    // Mouse button/wheel status (pauses playback when scrolling annotations).
    $annotWrap.on('pointerup pointerdown', e => {
      annotPointer = e.type !== 'pointerup'
    })
    $annotWrap.on('wheel', () => {
      clearTimeout(annotWheel)
      annotWheel = setTimeout(() => { annotWheel = null }, wheelIdleTime)
    })
  })
</script>
